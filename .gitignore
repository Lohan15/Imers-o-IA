!pip install -q google-generativeai spotipy

import os
import google.generativeai as genai
import spotipy
from spotipy.oauth2 import SpotifyClientCredentials
from google.colab import userdata
import random
import time


print("ğŸ” Verificando configuraÃ§Ãµes necessÃ¡rias...")
time.sleep(1)

try:

    os.environ["GOOGLE_API_KEY"] = userdata.get('GOOGLE_API_KEY')
    os.environ["SPOTIPY_CLIENT_ID"] = userdata.get('SPOTIPY_CLIENT_ID')
    os.environ["SPOTIPY_CLIENT_SECRET"] = userdata.get('SPOTIPY_CLIENT_SECRET')
    print("âœ… Chaves de API configuradas com sucesso!")
except Exception as e:
    print(f"ğŸ˜• Opa, algo deu errado: {e}")
    print("Por favor, verifique se vocÃª configurou corretamente as chaves no painel de segredos.")
    exit(1)
except Exception as e:
    print(f"ğŸ˜• Opa, algo deu errado: {e}")
    print("Por favor, verifique se vocÃª configurou corretamente as chaves no painel de segredos.")
    exit(1)


print("\nğŸ’¡ Iniciando serviÃ§os...")
time.sleep(1)

try:
    genai.configure(api_key=os.environ["GOOGLE_API_KEY"])
    modelo = genai.GenerativeModel("gemini-2.0-flash")
    print("ğŸ§  IA emocional pronta para conversar!")
except Exception as e:
    print(f"ğŸ¤– Ops! Problema ao conectar com a IA: {e}")
    exit(1)

try:
    sp = spotipy.Spotify(auth_manager=SpotifyClientCredentials(
        client_id=os.environ["SPOTIPY_CLIENT_ID"],
        client_secret=os.environ["SPOTIPY_CLIENT_SECRET"]
    ))
    print("ğŸµ ConexÃ£o com Spotify estabelecida!")
except Exception as e:
    print(f"ğŸ¶ Ah nÃ£o! Spotify indisponÃ­vel: {e}")
    exit(1)

print("\nâœ¨ Tudo pronto! Vamos comeÃ§ar nossa conversa!\n")
time.sleep(1)

historico_musicas = set()


saudacoes = [
    "Oi! Como vocÃª estÃ¡ se sentindo hoje?",
    "OlÃ¡! Quer compartilhar como estÃ¡ seu dia?",
    "Oi :) No que estÃ¡ pensando agora?",
    "E aÃ­? Tudo bem com vocÃª?",
    "Oi, amigo! Como vai o coraÃ§Ã£o hoje?"
]

despedidas = [
    "AtÃ© mais! Lembre-se: vocÃª Ã© incrÃ­vel!",
    "Foi Ã³timo conversar com vocÃª! Volte quando quiser :)",
    "Tchauzinho! Se cuida, ok?",
    "AtÃ© a prÃ³xima! Estarei aqui se precisar.",
    "Vou ficar por aqui. Qualquer hora vocÃª me chama!"
]

def mostrar_carregamento():
    for _ in range(3):
        print(".", end="", flush=True)
        time.sleep(0.5)
    print()

def detectar_emocao(texto):
    prompt = f"""
    Analise este texto com sensibilidade: "{texto}"
    Identifique a emoÃ§Ã£o predominante usando apenas uma destas palavras:
    feliz, triste, ansioso, relaxado, estressado, apaixonado, solitÃ¡rio, irritado, calmo, empolgado.
    Se nÃ£o for claro, responda 'indefinido'.
    """
    try:
        print("\nğŸ¤” Analisando suas palavras", end="")
        mostrar_carregamento()
        resposta = modelo.generate_content(prompt)
        emocao = resposta.text.strip().lower()
        return emocao if emocao in ["feliz", "triste", "ansioso", "relaxado", "estressado",
                                  "apaixonado", "solitÃ¡rio", "irritado", "calmo", "empolgado"] else "indefinido"
    except Exception as e:
        print(f"\nğŸ˜… NÃ£o consegui entender direito suas emoÃ§Ãµes agora")
        return "indefinido"

def recomendar_genero(emocao):
    mapa_emocional = {
        "triste": ["mÃºsica calma e encorajadora", "folk acÃºstico", "indie suave"],
        "feliz": ["pop animado", "funk brasileiro", "mÃºsica disco"],
        "ansioso": ["lo-fi relaxante", "jazz suave", "sons da natureza"],
        "relaxado": ["instrumental chill", "bossa nova", "mÃºsica ambiente"],
        "estressado": ["sons da natureza", "mÃºsica clÃ¡ssica", "meditaÃ§Ã£o guiada"],
        "apaixonado": ["romÃ¢ntico acÃºstico", "MPB", "R&B suave"],
        "solitÃ¡rio": ["acÃºstico melancÃ³lico", "blues", "indie folk"],
        "irritado": ["rock pesado", "metal", "punk rock"],
        "calmo": ["mÃºsica ambiente", "new age", "piano instrumental"],
        "empolgado": ["eletrÃ´nica danÃ§ante", "house music", "techno"],
        "indefinido": ["lo-fi", "mÃºsica ambiente", "playlist aleatÃ³ria"]
    }
    return random.choice(mapa_emocional.get(emocao, ["lo-fi"]))

def buscar_musica(query):
    try:
        print("\nğŸ” Procurando uma mÃºsica especial para vocÃª", end="")
        mostrar_carregamento()

        resultados = sp.search(q=query, type="track", limit=10)

        if resultados and resultados.get("tracks") and resultados["tracks"]["items"]:
            for item in resultados['tracks']['items']:
                nome = item['name']
                artista = item['artists'][0]['name']
                url = item['external_urls']['spotify']
                chave = (nome, artista)

                if chave not in historico_musicas:
                    historico_musicas.add(chave)
                    return {
                        "nome": nome,
                        "artista": artista,
                        "url": url,
                        "popularidade": item.get('popularity', 0)
                    }


        resultados = sp.search(q=random.choice(["lo-fi", "mÃºsica relaxante", "instrumental"]),
                             type="track", limit=1)

        if resultados and resultados.get("tracks") and resultados["tracks"]["items"]:
            item = resultados['tracks']['items'][0]
            return {
                "nome": item['name'],
                "artista": item['artists'][0]['name'],
                "url": item['external_urls']['spotify'],
                "popularidade": item.get('popularity', 0)
            }

    except Exception as e:
        print(f"\nğŸ¶ Opa, tive um probleminha para achar mÃºsicas: {e}")

    return None

def responder_usuario(texto, emocao):
    prompts_empaticos = [
        f"""VocÃª Ã© um amigo sensÃ­vel e atencioso. AlguÃ©m compartilhou: "{texto}"
        Demonstre que realmente entendeu o sentimento {emocao} por trÃ¡s dessa mensagem.
        Responda de forma calorosa, como um bom amigo faria, mostrando que vocÃª:
        1. Compreende o que eles estÃ£o sentindo
        2. Se importa genuinamente
        3. Oferece apoio sem ser clichÃª
        Seja natural, como em uma conversa real.""",

        f"""Imagine que um amigo chegou pra vocÃª e disse: "{texto}"
        Considerando que eles parecem estar se sentindo {emocao}, como vocÃª responderia?
        Seja empÃ¡tico, evite clichÃªs e mostre que realmente ouviu o que eles disseram.
        Uma resposta de verdadeiro amigo:""",

        f"""Com base nesta mensagem: "{texto}"
        O sentimento principal parece ser {emocao}.
        Escreva uma resposta que:
        - Valide os sentimentos da pessoa
        - Mostre compreensÃ£o genuÃ­na
        - OfereÃ§a conforto de forma natural
        - NÃ£o seja muito longo nem muito curto
        Lembre: vocÃª Ã© um amigo, nÃ£o um terapeuta!"""
    ]

    try:
        print("\nğŸ’­ Pensando em uma resposta significativa", end="")
        mostrar_carregamento()

        resposta = modelo.generate_content(random.choice(prompts_empaticos))
        return resposta.text.strip()
    except Exception as e:
        print(f"\nğŸ˜… Me perdi um pouco nos pensamentos aqui")
        return random.choice([
            "Hmm, preciso pensar melhor sobre isso...",
            "Deixe-me refletir sobre o que vocÃª disse...",
            "Isso me fez pensar... vocÃª poderia falar mais?",
            "Interessante... como isso tem feito vocÃª se sentir?"
        ])

def iniciar_conversa():
    print("\n" + "ğŸŒŸ"*20)
    print(random.choice(saudacoes))
    print("ğŸŒŸ"*20 + "\n")

    emocao_anterior = None
    genero_anterior = None

    while True:
        try:
            entrada = input("VocÃª: ").strip()

            if not entrada:
                print("\n" + random.choice([
                    "Fique Ã  vontade para compartilhar quando quiser...",
                    "Estou aqui quando vocÃª precisar conversar :)",
                    "Sempre que quiser bater um papo, Ã© sÃ³ chamar!"
                ]))
                continue

            if entrada.lower() in ["sair", "tchau", "adeus", "xau", "flw"]:
                print("\n" + random.choice(despedidas))
                break

            if any(palavra in entrada.lower() for palavra in ["outra mÃºsica", "mais mÃºsica", "nova mÃºsica"]):
                if genero_anterior:
                    sugestao = buscar_musica(genero_anterior)
                    if sugestao:
                        print(f"\nğŸµ SugestÃ£o musical: '{sugestao['nome']}' do {sugestao['artista']}")
                        print(f"ğŸ”— Abrir no Spotify: {sugestao['url']}")
                    else:
                        print("\nğŸ¤” NÃ£o encontrei nada agora... que tal me contar como vocÃª estÃ¡?")
                else:
                    print("\nğŸ¶ Antes de sugerir mÃºsicas, me conte como vocÃª estÃ¡ se sentindo :)")
                continue

            emocao_atual = detectar_emocao(entrada)
            genero_atual = recomendar_genero(emocao_atual)

            resposta = responder_usuario(entrada, emocao_atual)

            print(f"\nIA [{emocao_atual.capitalize()}]: {resposta}")

            sugestao = buscar_musica(genero_atual)
            if sugestao:
                print(f"\nğŸ§ RecomendaÃ§Ã£o musical para seu momento:")
                print(f"ğŸ¶ '{sugestao['nome']}' - {sugestao['artista']}")
                print(f"â­ Popularidade: {'â˜…' * (sugestao['popularidade'] // 20)}")
                print(f"ğŸ”— OuÃ§a aqui: {sugestao['url']}")
            else:
                print("\nğŸ¶ A mÃºsica perfeita para esse momento parece estar escondida...")

            emocao_anterior = emocao_atual
            genero_anterior = genero_atual

        except KeyboardInterrupt:
            print("\n\n" + random.choice([
                "Tudo bem, vamos parar por aqui...",
                "Entendi, podemos continuar outro dia :)",
                "Vou ficar por aqui entÃ£o. AtÃ© mais!"
            ]))
            break
        except Exception as e:
            print("\nğŸ˜… Opa, algo estranho aconteceu... Vamos recomeÃ§ar?")
            continue

if __name__ == "__main__":
    iniciar_conversa()
